<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æœ‰è¶£çš„é€£ç·šéŠæˆ²</title>
    <style>
        /* --- é€šç”¨æ¨£å¼ --- */
        body { font-family: 'PingFang TC', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; touch-action: manipulation; transition: background 0.5s; }
        .container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; margin-bottom: 20px; position: relative; z-index: 10; }
        .hidden { display: none !important; }
        
        /* æŒ‰éˆ•èˆ‡åˆ—è¡¨ */
        .menu-btn { width: 100%; padding: 15px; margin: 10px 0; font-size: 18px; cursor: pointer; border: none; border-radius: 8px; background: #007bff; color: white; transition: 0.2s; }
        .menu-btn:hover { background: #0056b3; }
        .btn-c4 { background: #2c3e50; } 
        .btn-purple { background: #6f42c1; } /* æ–°å¢ç´«è‰²æŒ‰éˆ•æ¨£å¼ */
        .btn-purple:hover { background: #59359a; }
        
        /* å°æŒ‰éˆ•æ¨£å¼ */
        .btn-sm { border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9em; margin-left: 5px; color: white; }
        .btn-green { background: #28a745; }
        .btn-red { background: #dc3545; }
        .btn-undo { background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-top: 10px; }

        /* æˆ¿é–“åˆ—è¡¨é …ç›® */
        .room-item { border: 1px solid #ddd; padding: 12px; margin: 10px 0; display: flex; justify-content: space-between; align-items: center; border-radius: 8px; background: #fafafa; }
        .room-info { text-align: left; display: flex; flex-direction: column; }
        .room-name { font-weight: bold; font-size: 1.1em; }
        .lock-icon { font-size: 0.8em; margin-left: 5px; color: #d9534f; }
        .room-meta { font-size: 0.75em; color: #888; margin-top: 2px; }
        
        /* é¦–é çµ±è¨ˆè³‡è¨Š */
        .stats-bar { background: #e9ecef; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em; color: #555; display: flex; justify-content: space-around; }
        .stat-item b { color: #007bff; font-size: 1.2em; }

        /* è¼¸å…¥æ¡† */
        input { padding: 8px; text-align: center; border: 1px solid #ccc; border-radius: 4px; }
        .input-group { margin: 10px 0; text-align: left; display: flex; align-items: center; justify-content: space-between; }
        .input-group label { font-weight: bold; width: 80px;}
        .input-group input { flex: 1; }
        
        /* è¨­å®šæ•¸å­—è¼¸å…¥æ¡†çš„å°æ¨£å¼ */
        .settings-row { display: flex; gap: 10px; margin: 10px 0; }
        .settings-item { flex: 1; display: flex; flex-direction: column; }
        .settings-item label { font-size: 0.8em; color: #555; margin-bottom: 3px; font-weight: bold; }
        .settings-item input { width: 100%; box-sizing: border-box; }

        /* --- éŠæˆ²å€å¡Š --- */
        #status { font-weight: bold; color: #d9534f; margin: 10px 0; min-height: 24px; }

        /* --- èŠå¤©å®¤ --- */
        #chat-area { margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; text-align: left; }
        #chat-msgs { height: 120px; overflow-y: auto; background: #f8f9fa; border-radius: 4px; padding: 5px; font-size: 0.85em; margin-bottom: 5px; border: 1px solid #ddd; }
        .chat-input-group { display: flex; gap: 5px; }
        .chat-input-group input { flex: 1; text-align: left; font-size: 0.9em; }
        
        /* æš±ç¨±ç·¨è¼¯æ¨£å¼ */
        .editable-name { color: #007bff; font-weight: bold; cursor: pointer; border-bottom: 1px dashed #007bff; }
        .editable-name:hover { color: #0056b3; border-bottom-style: solid; }

        /* --- å››é€£æ£‹æ¨£å¼ --- */
        :root { 
            --c4-cell-size: 40px; 
            --p1-color: #ff4d4d;
            --p2-color: #ffd93d;
        }
        #c4-game-wrapper { display: flex; flex-direction: column; align-items: center; background-color: rgba(44, 62, 80, 0.9); padding: 15px; border-radius: 10px; transition: 0.5s; max-width: 100%; overflow-x: auto; }
        .c4-board { display: grid; gap: 5px; padding: 10px; background: #3498db; border-radius: 10px; margin: 0 auto; }
        .c4-cell { width: var(--c4-cell-size); height: var(--c4-cell-size); background-color: #1a252f; border-radius: 50%; position: relative; }
        .piece { width: 100%; height: 100%; border-radius: 50%; animation: dropAnim 0.5s forwards; box-shadow: inset -3px -3px 5px rgba(0,0,0,0.3); }
        
        .p1 { background: var(--p1-color); }
        .p2 { background: var(--p2-color); }
        
        @keyframes dropAnim { from { transform: translateY(-200px); } to { transform: translateY(0); } }

        .color-pickers { margin-bottom: 10px; display: flex; gap: 10px; justify-content: center; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 8px; }
        .color-label { color: white; font-size: 0.8em; display: flex; align-items: center; gap: 5px; }
        input[type="color"] { border: none; width: 30px; height: 30px; padding: 0; cursor: pointer; background: none; }

        /* --- åœˆåœˆå‰å‰ (é€šç”¨æ£‹ç›¤) --- */
        #ttt-board { display: grid; gap: 5px; margin: 10px auto; background: #ccc; padding: 5px; border-radius: 5px; max-width: 100%; overflow-x: auto;}
        .ttt-cell { background: white; min-width: 40px; min-height: 40px; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; cursor: pointer; position: relative;}
        
        /* ç„¡é™æ¨¡å¼ï¼šå³å°‡æ¶ˆå¤±çš„æ£‹å­ç‰¹æ•ˆ */
        .about-to-die {
            opacity: 0.4;
            color: #d9534f;
            border: 2px dashed #d9534f;
            box-sizing: border-box;
        }
        .about-to-die::after {
            content: 'âš ï¸';
            font-size: 10px;
            position: absolute;
            bottom: 2px;
            right: 2px;
            opacity: 1;
        }

        /* --- å‹åˆ©ç‰¹æ•ˆ & å·¨å¤§æŒ‰éˆ• --- */
        #win-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; color: white; }
        /* é€™è£¡çš„é¡è‰²æœƒç”± JS å‹•æ…‹è¦†å¯« */
        #win-message { font-size: 3em; margin-bottom: 10px; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .big-reset-btn { padding: 20px 40px; font-size: 24px; font-weight: bold; background: #28a745; color: white; border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 0 20px rgba(40, 167, 69, 0.6); transition: 0.3s; margin-top: 20px;}
        .big-reset-btn:hover { transform: scale(1.1); }
    </style>
</head>
<body>

<div id="mainMenu" class="container">
    <h1>è‡ªå®šç¾©ç·šä¸ŠéŠæˆ²</h1>
    <div class="stats-bar">
        <div class="stat-item">å¤§å»³é–’ç½®: <b id="lobbyCount">0</b></div>
        <div class="stat-item">éŠæˆ²ä¸­: <b id="inGameCount">0</b></div>
    </div>

    <div id="allRoomsContainer">æœå°‹ä¸­...</div>
    <hr>
    <button class="menu-btn" onclick="showCreateRoom('ttt')">å‰µç«‹ åœˆåœˆå‰å‰â­•âŒ</button>
    <button class="menu-btn btn-c4" onclick="showCreateRoom('c4')">å‰µç«‹ å››é€£æ£‹ (é‡åŠ›è½ä¸‹)</button>
</div>

<div id="createRoomSection" class="container hidden">
    <h3 id="createTitle">å‰µç«‹æˆ¿é–“</h3>
    
    <div class="input-group"><label>æˆ¿é–“åç¨±:</label><input type="text" id="roomName" placeholder="æœªå‘½åæˆ¿é–“"></div>
    <div class="input-group"><label>è¨­å®šå¯†ç¢¼:</label><input type="password" id="roomPass" placeholder="å¯ç•™ç©º"></div>

    <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
    
    <div style="text-align: left; font-weight: bold; margin-bottom: 5px;">éŠæˆ²è¦å‰‡è¨­å®š:</div>
    <div class="settings-row">
        <div class="settings-item">
            <label>é«˜ (Rows)</label>
            <input type="number" id="inputRows" min="3" max="15" value="3">
        </div>
        <div class="settings-item">
            <label>å¯¬ (Cols)</label>
            <input type="number" id="inputCols" min="3" max="15" value="3">
        </div>
        <div class="settings-item">
            <label>é€£ç·šæ•¸</label>
            <input type="number" id="inputWin" min="3" max="10" value="3">
        </div>
    </div>
    
    <div id="infinite-hint" style="font-size: 0.8em; color: #6f42c1; margin-bottom: 10px; display:none;">
        â€» ç„¡é™æ¨¡å¼ï¼šé›™æ–¹æœ€å¤šåªèƒ½æœ‰ 3 é¡†æ£‹å­ï¼Œä¸‹ç¬¬ 4 é¡†æ™‚æœ€æ—©çš„æœƒæ¶ˆå¤±ã€‚å»ºè­° 3x3ã€‚
    </div>
    <div id="normal-hint" style="font-size: 0.8em; color: #d9534f; margin-bottom: 10px;">
        â€» å»ºè­°æœ€å¤§ 15x15ï¼Œä»¥å…æ‰‹æ©Ÿç•«é¢å¤ªæ“ 
    </div>

    <button id="btn-confirm" class="menu-btn" onclick="createRoom()">ç¢ºèªå‰µç«‹</button>
    <button id="btn-infinite" class="menu-btn btn-purple hidden" onclick="createInfiniteRoom()">å‰µç«‹ ç„¡é™åœˆåœˆå‰å‰ (åªç•™ä¸‰å­)</button>
    
    <button onclick="showSection('mainMenu')">è¿”å›</button>
</div>

<div id="gameArea" class="container hidden">
    <h3 id="roomDisplayInfo"></h3>
    <div id="gameMetaInfo" style="font-size: 0.85em; color: #666; margin-bottom: 5px;"></div>
    <div id="status">è¼‰å…¥ä¸­...</div>

    <div id="ttt-board" class="hidden"></div>
    
    <div id="c4-game-wrapper" class="hidden">
        <div class="color-pickers">
            <label class="color-label">P1è‰²: <input type="color" id="p1ColorPicker" value="#ff4d4d"></label>
            <label class="color-label">P2è‰²: <input type="color" id="p2ColorPicker" value="#ffd93d"></label>
        </div>
        <div id="c4-board" class="c4-board"></div>
    </div>

    <button class="btn-undo" onclick="undoStep()">â¬… æ‚”æ£‹ (å›ä¸Šä¸€æ­¥)</button>

    <div id="chat-area">
        <div style="margin-bottom: 5px; font-size: 0.9em; color: #555;">
            æˆ‘æ˜¯: <span id="myNameDisplay" class="editable-name" onclick="editName()">ç©å®¶</span> âœ
        </div>
        
        <div id="chat-msgs"></div>
        <div class="chat-input-group">
            <input type="text" id="chatInput" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()">å‚³é€</button>
        </div>
    </div>

    <div style="margin-top: 20px;">
        <button onclick="resetGame()">é‡æ–°é–‹å§‹</button>
        <button onclick="leaveRoom()">é›¢é–‹æˆ¿é–“</button>
    </div>
</div>

<div id="win-overlay">
    <h1 id="win-message">å‹åˆ©ï¼</h1>
    <button class="big-reset-btn" onclick="resetGame()">ğŸ”„ é‡æ–°é–‹å§‹ ğŸ”„</button>
    <button style="margin-top:15px; background:none; border:1px solid white; color:white; padding:5px 10px; border-radius:20px;" onclick="closeWinOverlay()">æš«æ™‚é—œé–‰</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, update, remove, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC7PZLTTNf17cfp9gCHudWiWX8SYPSCdDI",
        authDomain: "onlineeasyraygame.firebaseapp.com",
        databaseURL: "https://onlineeasyraygame-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "onlineeasyraygame"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let currentRoomId = null, selectedGameType = 'ttt', roomDataCache = null;
    let currentUserKey = null;
    
    let myName = "ç©å®¶" + Math.floor(Math.random() * 100);

    // --- å…¨ç«™ç·šä¸Šäººæ•¸çµ±è¨ˆ ---
    const onlineRef = push(ref(db, 'online'));
    onDisconnect(onlineRef).remove();
    set(onlineRef, true);

    let totalOnlineCount = 0;
    onValue(ref(db, 'online'), (snapshot) => {
        const val = snapshot.val();
        totalOnlineCount = val ? Object.keys(val).length : 0;
        updateStatsUI();
    });

    // --- åˆå§‹åŒ–ï¼šé¡¯ç¤ºæ‰€æœ‰æˆ¿é–“ ---
    let totalInGameCount = 0;

    function initLobby() {
        onValue(ref(db, 'rooms'), (snapshot) => {
            const container = document.getElementById('allRoomsContainer');
            container.innerHTML = "";
            const rooms = snapshot.val();
            
            totalInGameCount = 0;

            if (!rooms) { 
                container.innerHTML = "<p>ç›®å‰æ²’æœ‰æˆ¿é–“ï¼Œä¾†é–‹ä¸€å€‹å§ï¼</p>"; 
                updateStatsUI();
                return; 
            }
            
            Object.entries(rooms).reverse().forEach(([id, r]) => {
                const userCount = r.users ? Object.keys(r.users).length : 0;
                totalInGameCount += userCount;

                let typeName = 'âŒä¸€èˆ¬åœˆå‰';
                if (r.type === 'c4') typeName = 'ğŸ”µé‡åŠ›å››é€£';
                if (r.type === 'ttt-infinite') typeName = 'â™¾ï¸ç„¡é™åœˆå‰';

                const hasPass = r.password && r.password !== "";
                const lockIcon = hasPass ? '<span class="lock-icon">ğŸ”’</span>' : '';
                const passwordArg = hasPass ? r.password : ""; 
                
                const rows = r.rows || (r.type === 'c4' ? 6 : 3);
                const cols = r.cols || (r.type === 'c4' ? 7 : 3);
                const win = r.winCondition || (r.type === 'c4' ? 4 : 3);

                const div = document.createElement('div');
                div.className = 'room-item';
                div.innerHTML = `
                    <div class="room-info">
                        <span class="room-name">${typeName} | ${r.name} ${lockIcon}</span>
                        <div class="room-meta">å¤§å°: ${rows}x${cols} | é€£ç·š: ${win} | äººæ•¸: ${userCount}</div>
                    </div>
                    <div>
                        <button class="btn-sm btn-green" onclick="attemptJoin('${id}', '${passwordArg}')">åŠ å…¥</button>
                        <button class="btn-sm btn-red" onclick="deleteRoom('${id}')">åˆªé™¤</button>
                    </div>`;
                container.appendChild(div);
            });
            updateStatsUI();
        });
    }
    initLobby();

    function updateStatsUI() {
        const lobbyCount = Math.max(0, totalOnlineCount - totalInGameCount);
        document.getElementById('inGameCount').innerText = totalInGameCount;
        document.getElementById('lobbyCount').innerText = lobbyCount;
    }

    window.attemptJoin = (id, correctPass) => {
        if (correctPass && correctPass !== "undefined" && correctPass !== "") {
            const input = prompt("æ­¤æˆ¿é–“æœ‰å¯†ç¢¼ï¼Œè«‹è¼¸å…¥ï¼š");
            if (input !== correctPass) {
                alert("å¯†ç¢¼éŒ¯èª¤ï¼");
                return;
            }
        }
        enterRoom(id);
    };

    const p1Picker = document.getElementById('p1ColorPicker');
    const p2Picker = document.getElementById('p2ColorPicker');
    
    function updateLocalColors() {
        document.documentElement.style.setProperty('--p1-color', p1Picker.value);
        document.documentElement.style.setProperty('--p2-color', p2Picker.value);
    }
    function saveColorsToDB() {
        if(currentRoomId) {
            update(ref(db, 'rooms/' + currentRoomId), {
                p1Color: p1Picker.value,
                p2Color: p2Picker.value
            });
        }
    }
    
    p1Picker.addEventListener('input', updateLocalColors);
    p2Picker.addEventListener('input', updateLocalColors);
    p1Picker.addEventListener('change', saveColorsToDB);
    p2Picker.addEventListener('change', saveColorsToDB);


    window.deleteRoom = (id) => {
        if(confirm("ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™å€‹æˆ¿é–“å—ï¼Ÿ")) {
            remove(ref(db, 'rooms/' + id)).then(() => alert("æˆ¿é–“å·²åˆªé™¤"));
        }
    };

    // --- æˆ¿é–“ç®¡ç† ---
    window.showCreateRoom = (type) => {
        selectedGameType = type;
        
        let title = "å‰µç«‹æˆ¿é–“";
        if(type === 'c4') title = 'å‰µç«‹ å››é€£æ£‹ (é‡åŠ›è½ä¸‹)';
        if(type === 'ttt') title = 'å‰µç«‹ æ£‹ç›¤é€£ç·š'; // ä¿®æ”¹æ¨™é¡Œï¼Œå› ç‚ºç¾åœ¨åŒ…å«å…©ç¨®æ¨¡å¼

        document.getElementById('createTitle').innerText = title;
        
        // --- ä¿®æ”¹è™•ï¼šæ ¹æ“šé¸æ“‡çš„éŠæˆ²é¡å‹é¡¯ç¤º/éš±è—ç„¡é™æ¨¡å¼æŒ‰éˆ•èˆ‡æç¤º ---
        const btnInfinite = document.getElementById('btn-infinite');
        const btnConfirm = document.getElementById('btn-confirm');
        const infiniteHint = document.getElementById('infinite-hint');
        const normalHint = document.getElementById('normal-hint');

        if (type === 'c4') {
            document.getElementById('inputRows').value = 6;
            document.getElementById('inputCols').value = 7;
            document.getElementById('inputWin').value = 4;
            
            // å››é€£æ£‹æ¨¡å¼ï¼šéš±è—ç„¡é™æŒ‰éˆ•ï¼Œé¡¯ç¤ºæ¨™æº–æç¤º
            btnInfinite.classList.add('hidden');
            btnConfirm.innerText = "ç¢ºèªå‰µç«‹";
            btnConfirm.onclick = createRoom; // æ¢å¾©æ¨™æº–å‰µç«‹

            infiniteHint.style.display = 'none';
            normalHint.style.display = 'block';
        } else {
            // åœˆåœˆå‰å‰æ¨¡å¼ï¼šé è¨­ 3x3
            document.getElementById('inputRows').value = 3;
            document.getElementById('inputCols').value = 3;
            document.getElementById('inputWin').value = 3;
            
            // é¡¯ç¤ºç„¡é™æŒ‰éˆ•ï¼Œä¸¦ä¿®æ”¹æ¨™æº–æŒ‰éˆ•æ–‡å­—
            btnInfinite.classList.remove('hidden');
            btnConfirm.innerText = "å‰µç«‹ ä¸€èˆ¬åœˆåœˆå‰å‰";
            // ç¢ºä¿é»æ“Šä¸€èˆ¬æŒ‰éˆ•æ™‚æ˜¯ä¸€èˆ¬æ¨¡å¼
            btnConfirm.onclick = () => { selectedGameType = 'ttt'; createRoom(); };

            infiniteHint.style.display = 'none';
            normalHint.style.display = 'block';
        }

        showSection('createRoomSection');
    };

    // ä¿®æ”¹è™•ï¼šæ–°å¢ä¸€å€‹å°ˆé–€å‰µç«‹ç„¡é™æ¨¡å¼çš„å‡½æ•¸
    window.createInfiniteRoom = () => {
        selectedGameType = 'ttt-infinite';
        createRoom();
    };

    window.createRoom = () => {
        const name = document.getElementById('roomName').value || "å¥½ç©æˆ¿é–“";
        const pass = document.getElementById('roomPass').value;
        
        let rows = parseInt(document.getElementById('inputRows').value) || 3;
        let cols = parseInt(document.getElementById('inputCols').value) || 3;
        let win = parseInt(document.getElementById('inputWin').value) || 3;

        if(rows < 3) rows = 3; if(cols < 3) cols = 3; if(win < 3) win = 3;
        if(win > Math.max(rows, cols)) { alert("é€£ç·šæ•¸ä¸èƒ½å¤§æ–¼æ£‹ç›¤é•·å¯¬ï¼"); return; }
        
        const roomRef = push(ref(db, 'rooms'));
        const initBoard = selectedGameType === 'c4' 
            ? Array(rows * cols).fill(0) 
            : Array(rows * cols).fill("");
        
        // é è¨­é¡è‰²
        const defaultP1 = "#ff4d4d";
        const defaultP2 = "#ffd93d";

        const roomData = {
            type: selectedGameType, name, password: pass,
            board: initBoard, turn: 0, 
            rows: rows, cols: cols, winCondition: win,
            p1Color: defaultP1, p2Color: defaultP2
        };

        // å¦‚æœæ˜¯ç„¡é™æ¨¡å¼ï¼Œéœ€è¦åˆå§‹åŒ–ç§»å‹•ç´€éŒ„
        if (selectedGameType === 'ttt-infinite') {
            roomData.moves = []; // å­˜å„² { index: 0, player: "X" }
            roomData.history = [{ board: initBoard, moves: [] }];
        } else {
            roomData.history = [initBoard];
        }

        set(roomRef, roomData).then(() => enterRoom(roomRef.key));
    };

    window.enterRoom = (id) => {
        currentRoomId = id;
        showSection('gameArea');
        document.getElementById('myNameDisplay').innerText = myName;

        const userRef = push(ref(db, `rooms/${id}/users`));
        currentUserKey = userRef.key;
        onDisconnect(userRef).remove();
        set(userRef, { name: myName });

        onValue(ref(db, 'rooms/' + id), (snapshot) => {
            const data = snapshot.val();
            if (!data) { alert("æˆ¿é–“å·²è¢«åˆªé™¤"); leaveRoom(); return; }
            roomDataCache = data;
            renderGame(data);
            checkWinner(data);
        });

        onValue(ref(db, `rooms/${id}/chat`), (snapshot) => {
            const chatDiv = document.getElementById('chat-msgs');
            chatDiv.innerHTML = "";
            const msgs = snapshot.val();
            if(msgs) {
                Object.values(msgs).forEach(m => {
                    const p = document.createElement('div');
                    p.innerHTML = `<b>${m.user}:</b> ${m.text}`;
                    chatDiv.appendChild(p);
                });
                chatDiv.scrollTop = chatDiv.scrollHeight;
            }
        });
    };

    window.editName = () => {
        const newName = prompt("è«‹è¼¸å…¥æ‚¨çš„æ–°æš±ç¨±:", myName);
        if (newName && newName.trim() !== "") {
            myName = newName.trim();
            document.getElementById('myNameDisplay').innerText = myName;
            
            if (currentRoomId && currentUserKey) {
                update(ref(db, `rooms/${currentRoomId}/users/${currentUserKey}`), { name: myName });
            }
        }
    };

    // --- éŠæˆ²é‚è¼¯ ---
    function renderGame(data) {
        document.getElementById('roomDisplayInfo').innerText = data.name;
        
        const rows = data.rows || (data.type === 'c4' ? 6 : 3);
        const cols = data.cols || (data.type === 'c4' ? 7 : 3);
        const win = data.winCondition || (data.type === 'c4' ? 4 : 3);
        
        const userList = data.users ? Object.values(data.users) : [];
        const userCount = userList.length;
        let typeStr = "ä¸€èˆ¬åœˆå‰";
        if (data.type === 'ttt-infinite') typeStr = "ç„¡é™åœˆå‰";
        if (data.type === 'c4') typeStr = "é‡åŠ›å››é€£";

        document.getElementById('gameMetaInfo').innerText = `æ¨¡å¼: ${typeStr} | è¦æ ¼: ${rows}x${cols} | é€£ç·š: ${win} | äººæ•¸: ${userCount}äºº`;

        const p1Name = userList[0] ? userList[0].name : "ç©å®¶ 1";
        const p2Name = userList[1] ? userList[1].name : "ç©å®¶ 2";
        const currentPlayerName = (data.turn % 2 === 0) ? p1Name : p2Name;

        // åŒæ­¥é¡è‰²
        if(data.type === 'c4') {
            if(data.p1Color && data.p1Color !== p1Picker.value) {
                p1Picker.value = data.p1Color;
                document.documentElement.style.setProperty('--p1-color', data.p1Color);
            }
            if(data.p2Color && data.p2Color !== p2Picker.value) {
                p2Picker.value = data.p2Color;
                document.documentElement.style.setProperty('--p2-color', data.p2Color);
            }
        }

        if (data.type === 'c4') {
            // ... å››é€£æ£‹æ¸²æŸ“é‚è¼¯ä¿æŒä¸è®Š ...
            document.getElementById('ttt-board').classList.add('hidden');
            document.getElementById('c4-game-wrapper').classList.remove('hidden');
            const boardDiv = document.getElementById('c4-board');
            
            boardDiv.style.gridTemplateColumns = `repeat(${cols}, var(--c4-cell-size))`;
            
            const size = cols > 10 ? '30px' : (cols > 7 ? '35px' : '45px');
            document.documentElement.style.setProperty('--c4-cell-size', size);

            boardDiv.innerHTML = "";
            data.board.forEach((val, i) => {
                const cell = document.createElement('div');
                cell.className = 'c4-cell';
                if(val > 0) cell.innerHTML = `<div class="piece p${val}"></div>`;
                cell.onclick = () => dropC4(i % cols, rows, cols);
                boardDiv.appendChild(cell);
            });
            const turnSymbol = (data.turn % 2 === 0) ? '(P1)' : '(P2)';
            document.getElementById('status').innerText = `è¼ªåˆ°: ${currentPlayerName} ${turnSymbol}`;
            document.getElementById('status').style.color = (data.turn % 2 === 0) ? (data.p1Color || '#ff4d4d') : (data.p2Color || '#ffd93d');

        } else {
            // ... åœˆåœˆå‰å‰ (ä¸€èˆ¬ & ç„¡é™) ...
            document.getElementById('c4-game-wrapper').classList.add('hidden');
            document.getElementById('ttt-board').classList.remove('hidden');
            const boardDiv = document.getElementById('ttt-board');
            
            boardDiv.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            
            boardDiv.innerHTML = "";

            // è¨ˆç®—å“ªäº›æ£‹å­å³å°‡æ¶ˆå¤± (åƒ…é™ç„¡é™æ¨¡å¼)
            let indexToFade = -1;
            if (data.type === 'ttt-infinite' && data.moves) {
                // æ‰¾å‡ºç•¶å‰æ‰€æœ‰æ£‹å­
                const moves = data.moves;
                const p1Moves = moves.filter(m => m.player === 'X');
                const p2Moves = moves.filter(m => m.player === 'O');
                
                // å¦‚æœç¾åœ¨æ˜¯æŸäººçš„å›åˆï¼Œä¸”ä»–å·²ç¶“æœ‰3å­ï¼Œé‚£ä»–"æœ€èˆŠ"çš„é‚£å­å°±æ˜¯ä¸‹ä¸€æ‰‹æœƒæ¶ˆå¤±çš„
                // æˆ–è€…æ˜¯é¡¯ç¤º"å ´ä¸Šæœ€èˆŠçš„å­"ï¼Ÿé€šå¸¸æ˜¯é¡¯ç¤º"å¦‚æœæˆ‘ä¸‹ï¼Œå“ªé¡†æœƒæ¶ˆ"
                // ç•¶å‰è¼ªåˆ°çš„äººï¼š
                const currentSymbol = (data.turn % 2 === 0) ? 'X' : 'O';
                const myMoves = (currentSymbol === 'X') ? p1Moves : p2Moves;

                if (myMoves.length >= 3) {
                    // æœ€èˆŠçš„é‚£å€‹
                    indexToFade = myMoves[0].index;
                }
            }

            data.board.forEach((val, i) => {
                const cell = document.createElement('div');
                cell.className = 'ttt-cell';
                if (i === indexToFade) {
                    cell.classList.add('about-to-die');
                }
                cell.innerText = val;
                cell.onclick = () => clickTTT(i);
                boardDiv.appendChild(cell);
            });
            document.getElementById('status').innerText = `è¼ªåˆ°: ${currentPlayerName} (${data.turn % 2 === 0 ? 'X' : 'O'})`;
            document.getElementById('status').style.color = '#d9534f';
        }
    }

    function dropC4(col, rows, cols) {
        const board = [...roomDataCache.board];
        for (let r = rows - 1; r >= 0; r--) {
            const index = r * cols + col;
            if (board[index] === 0) {
                board[index] = (roomDataCache.turn % 2) + 1;
                updateMove(board);
                break;
            }
        }
    }

    function clickTTT(i) {
        if (roomDataCache.board[i] !== "") return; // æ ¼å­æœ‰æ±è¥¿ä¸èƒ½ä¸‹
        
        const isInfinite = (roomDataCache.type === 'ttt-infinite');
        const board = [...roomDataCache.board];
        const currentPlayer = roomDataCache.turn % 2 === 0 ? "X" : "O";
        
        let newMoves = [];
        if (isInfinite) {
            newMoves = roomDataCache.moves ? [...roomDataCache.moves] : [];
        }

        // ä¸‹å­
        board[i] = currentPlayer;
        
        // å¦‚æœæ˜¯ç„¡é™æ¨¡å¼ï¼Œè™•ç†ç§»é™¤é‚è¼¯
        if (isInfinite) {
            newMoves.push({ index: i, player: currentPlayer });
            
            // æª¢æŸ¥è©²ç©å®¶æ˜¯å¦è¶…é 3 å­
            const myMoves = newMoves.filter(m => m.player === currentPlayer);
            if (myMoves.length > 3) {
                const moveToRemove = myMoves[0]; // æœ€èˆŠçš„
                // å¾æ£‹ç›¤ç§»é™¤
                board[moveToRemove.index] = "";
                // å¾ç´€éŒ„ç§»é™¤ (è¦æ‰¾ä»–åœ¨ä¸»é™£åˆ—çš„ä½ç½®)
                const realIndex = newMoves.indexOf(moveToRemove);
                if (realIndex > -1) {
                    newMoves.splice(realIndex, 1);
                }
            }
            updateMove(board, newMoves);
        } else {
            // ä¸€èˆ¬æ¨¡å¼
            updateMove(board);
        }
    }

    function updateMove(newBoard, newMoves = null) {
        const history = roomDataCache.history || [];
        const isInfinite = (roomDataCache.type === 'ttt-infinite');

        if (isInfinite) {
            // ç„¡é™æ¨¡å¼ History å­˜ç‰©ä»¶ { board, moves }
            history.push({ board: newBoard, moves: newMoves });
            update(ref(db, `rooms/${currentRoomId}`), {
                board: newBoard,
                moves: newMoves,
                turn: roomDataCache.turn + 1,
                history: history
            });
        } else {
            // ä¸€èˆ¬æ¨¡å¼ History å­˜ board é™£åˆ—
            history.push(newBoard);
            update(ref(db, `rooms/${currentRoomId}`), {
                board: newBoard,
                turn: roomDataCache.turn + 1,
                history: history
            });
        }
    }

    window.undoStep = () => {
        const history = roomDataCache.history || [];
        if (history.length <= 1) return alert("ä¸èƒ½å†é€€äº†ï¼");
        
        history.pop(); // ç§»é™¤ç¾åœ¨ç‹€æ…‹
        const lastState = history[history.length - 1]; // å–å¾—ä¸Šä¸€å€‹ç‹€æ…‹
        
        const isInfinite = (roomDataCache.type === 'ttt-infinite');
        
        if (isInfinite) {
            // lastState æ‡‰è©²æ˜¯ { board, moves }
            // å…¼å®¹æ€§æª¢æŸ¥ï¼šå¦‚æœèˆŠè³‡æ–™æ²’æœ‰ movesï¼Œå¯èƒ½æœƒå ±éŒ¯ï¼Œç¨å¾®é˜²å‘†ä¸€ä¸‹
            const prevBoard = lastState.board || lastState; 
            const prevMoves = lastState.moves || [];

            update(ref(db, `rooms/${currentRoomId}`), {
                board: prevBoard,
                moves: prevMoves,
                turn: roomDataCache.turn - 1,
                history: history
            });
        } else {
            // ä¸€èˆ¬æ¨¡å¼ lastState æ˜¯ board Array
            update(ref(db, `rooms/${currentRoomId}`), {
                board: lastState,
                turn: roomDataCache.turn - 1,
                history: history
            });
        }
    };

    window.sendMessage = () => {
        const input = document.getElementById('chatInput');
        if (!input.value.trim()) return;
        push(ref(db, `rooms/${currentRoomId}/chat`), {
            user: myName,
            text: input.value,
            time: serverTimestamp()
        });
        input.value = "";
    };

    function checkWinner(data) {
        const rows = data.rows || (data.type === 'c4' ? 6 : 3);
        const cols = data.cols || (data.type === 'c4' ? 7 : 3);
        const winTarget = data.winCondition || (data.type === 'c4' ? 4 : 3);
        const emptyVal = data.type === 'c4' ? 0 : "";

        const winner = checkWinGeneral(data.board, rows, cols, winTarget, emptyVal);
        const msgEl = document.getElementById('win-message');

        if (winner) {
            const userList = data.users ? Object.values(data.users) : [];
            let winnerName = "";
            let winSymbol = "";
            let winColor = "#ffffff";

            if (winner === 'X' || winner === 1) {
                winnerName = userList[0] ? userList[0].name : "ç©å®¶ 1";
                winSymbol = (data.type === 'c4') ? '(P1)' : '(X)';
                if(data.type === 'c4') winColor = data.p1Color || document.getElementById('p1ColorPicker').value;
            } else if (winner === 'O' || winner === 2) {
                winnerName = userList[1] ? userList[1].name : "ç©å®¶ 2";
                winSymbol = (data.type === 'c4') ? '(P2)' : '(O)';
                if(data.type === 'c4') winColor = data.p2Color || document.getElementById('p2ColorPicker').value;
            }

            msgEl.innerText = `ğŸ‰ æ­å–œ ${winnerName} ${winSymbol} ç²å‹ï¼ ğŸ‰`;
            msgEl.style.color = winColor;
            
            document.getElementById('win-overlay').style.display = 'flex';
        } else {
            // å¹³æ‰‹åˆ¤å®šï¼šå¦‚æœæ˜¯ç„¡é™æ¨¡å¼ï¼Œç†è«–ä¸Šå¾ˆé›£å¹³æ‰‹(é™¤éæ ¼å­å¾ˆå°‘)ï¼Œä¸”æ°¸é ä¸æœƒæ»¿ç›¤
            // æ‰€ä»¥ç„¡é™æ¨¡å¼åªæª¢æŸ¥"æ˜¯å¦æœ‰äººè´"ã€‚
            // åªæœ‰ä¸€èˆ¬æ¨¡å¼æ‰æª¢æŸ¥å¹³æ‰‹
            if (data.type !== 'ttt-infinite') {
                const isFull = data.board.every(cell => cell !== 0 && cell !== "");
                if (isFull) {
                     msgEl.innerText = `ğŸ¤ å¹³æ‰‹ï¼ ğŸ¤`;
                     msgEl.style.color = "white";
                     document.getElementById('win-overlay').style.display = 'flex';
                } else {
                    document.getElementById('win-overlay').style.display = 'none';
                }
            } else {
                 document.getElementById('win-overlay').style.display = 'none';
            }
        }
    }

    function checkWinGeneral(board, rows, cols, target, emptyVal) {
        const getCell = (r, c) => {
            if(r < 0 || r >= rows || c < 0 || c >= cols) return null;
            return board[r * cols + c];
        };

        const directions = [
            [0, 1], [1, 0], [1, 1], [1, -1] 
        ];

        for(let r = 0; r < rows; r++) {
            for(let c = 0; c < cols; c++) {
                const current = getCell(r, c);
                if (current === emptyVal || current === null) continue;

                for (let [dr, dc] of directions) {
                    let count = 1;
                    for (let k = 1; k < target; k++) {
                        if (getCell(r + dr * k, c + dc * k) === current) {
                            count++;
                        } else {
                            break;
                        }
                    }
                    if (count === target) return current;
                }
            }
        }
        return null;
    }

    window.resetGame = () => {
        const rows = roomDataCache.rows || (roomDataCache.type === 'c4' ? 6 : 3);
        const cols = roomDataCache.cols || (roomDataCache.type === 'c4' ? 7 : 3);
        
        const initBoard = roomDataCache.type === 'c4' 
            ? Array(rows*cols).fill(0) 
            : Array(rows*cols).fill("");
            
        // é‡ç½®æ™‚ä¹Ÿè¦è€ƒæ…®ç„¡é™æ¨¡å¼çš„ moves
        if (roomDataCache.type === 'ttt-infinite') {
            set(ref(db, `rooms/${currentRoomId}/history`), [{ board: initBoard, moves: [] }]);
            update(ref(db, `rooms/${currentRoomId}`), { board: initBoard, moves: [], turn: 0 });
        } else {
            set(ref(db, `rooms/${currentRoomId}/history`), [initBoard]);
            update(ref(db, `rooms/${currentRoomId}`), { board: initBoard, turn: 0 });
        }
        closeWinOverlay();
    };

    window.closeWinOverlay = () => document.getElementById('win-overlay').style.display = 'none';
    window.showSection = (id) => {
        document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    };
    window.leaveRoom = () => location.reload();
</script>
</body>
</html>
